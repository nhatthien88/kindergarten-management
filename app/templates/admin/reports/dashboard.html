{% extends "admin/base.html" %}

{% block title %}Dashboard Thá»‘ng kÃª{% endblock %}
{% block page_title %}ğŸ“Š Dashboard Thá»‘ng kÃª{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Metrics Grid -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-icon">ğŸ‘¶</div>
        <div class="metric-value">{{ stats.total_students }}</div>
        <div class="metric-label">Tá»•ng sá»‘ há»c sinh</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">ğŸ‘¨â€ğŸ«</div>
        <div class="metric-value">{{ stats.total_teachers }}</div>
        <div class="metric-label">Tá»•ng sá»‘ giÃ¡o viÃªn</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
        <div class="metric-value">{{ stats.total_parents }}</div>
        <div class="metric-label">Tá»•ng sá»‘ phá»¥ huynh</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">ğŸ’°</div>
        <div class="metric-value">{{ "{:,.0f}".format(stats.revenue_this_month) }}Ä‘</div>
        <div class="metric-label">Doanh thu thÃ¡ng nÃ y</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">â³</div>
        <div class="metric-value">{{ stats.pending_fees }}</div>
        <div class="metric-label">Há»c phÃ­ chá» thanh toÃ¡n</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-icon">âš ï¸</div>
        <div class="metric-value">{{ stats.overdue_fees }}</div>
        <div class="metric-label">Há»c phÃ­ quÃ¡ háº¡n</div>
    </div>
</div>

<!-- Charts -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
    <!-- Revenue Trend Chart -->
    <div class="chart-container">
        <h3>ğŸ“ˆ Doanh thu 6 thÃ¡ng gáº§n nháº¥t</h3>
        <canvas id="revenueTrendChart"></canvas>
    </div>
    
    <!-- Gender Distribution Chart -->
    <div class="chart-container">
        <h3>ğŸ‘¦ğŸ‘§ Tá»· lá»‡ giá»›i tÃ­nh há»c sinh</h3>
        <canvas id="genderChart"></canvas>
    </div>
</div>

<!-- Recent Overdue Fees -->
{% if recent_fees %}
<div class="table-container" style="margin-top: 30px;">
    <h3>âš ï¸ Há»c phÃ­ quÃ¡ háº¡n gáº§n Ä‘Ã¢y</h3>
    <table>
        <thead>
            <tr>
                <th>Há»c sinh</th>
                <th>ThÃ¡ng/NÄƒm</th>
                <th>Sá»‘ tiá»n</th>
                <th>Háº¡n thanh toÃ¡n</th>
                <th>Thao tÃ¡c</th>
            </tr>
        </thead>
        <tbody>
            {% for fee in recent_fees %}
            <tr>
                <td>{{ fee.student.full_name }}</td>
                <td>{{ fee.month }}/{{ fee.year }}</td>
                <td>{{ "{:,.0f}".format(fee.remaining_amount) }}Ä‘</td>
                <td>{{ fee.due_date.strftime('%d/%m/%Y') if fee.due_date else '-' }}</td>
                <td>
                    <a href="{{ url_for('admin.fee_detail', fee_id=fee.id) }}" class="btn btn-sm btn-primary">Chi tiáº¿t</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
// Revenue Trend Chart
const revenueTrendData = {{ revenue_trend | tojson }};
const revenueLabels = revenueTrendData.map(d => d.label);
const revenueValues = revenueTrendData.map(d => d.value);

new Chart(document.getElementById('revenueTrendChart'), {
    type: 'line',
    data: {
        labels: revenueLabels,
        datasets: [{
            label: 'Doanh thu (VND)',
            data: revenueValues,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        }
    }
});

// Gender Distribution Chart
const genderData = {{ gender_dist | tojson }};
const genderLabels = Object.keys(genderData);
const genderValues = Object.values(genderData);

new Chart(document.getElementById('genderChart'), {
    type: 'pie',
    data: {
        labels: genderLabels,
        datasets: [{
            label: 'Sá»‘ há»c sinh',
            data: genderValues,
            backgroundColor: [
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 99, 132, 0.5)'
            ],
            borderColor: [
                'rgb(54, 162, 235)',
                'rgb(255, 99, 132)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        }
    }
});
</script>
{% endblock %}
