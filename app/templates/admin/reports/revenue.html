{% extends "admin/base.html" %}

{% block title %}B√°o c√°o Doanh thu{% endblock %}
{% block page_title %}üí∞ B√°o c√°o Doanh thu{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Filter Bar -->
<div class="filter-bar">
    <form method="GET" action="{{ url_for('admin.revenue_report') }}">
        <div class="filter-group">
            <div class="filter-item">
                <label>Th√°ng</label>
                <select name="month" class="form-control">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if month == m %}selected{% endif %}>Th√°ng {{ m }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-item">
                <label>NƒÉm</label>
                <input type="number" class="form-control" name="year" value="{{ year }}" min="2020" max="2030">
            </div>
            <div class="filter-item">
                <button type="submit" class="btn btn-primary">üîç Xem b√°o c√°o</button>
            </div>
        </div>
    </form>
</div>

<!-- Charts -->
<div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
    <!-- Revenue by Classroom (Bar Chart) -->
    <div class="chart-container">
        <h3>üìä Doanh thu theo l·ªõp h·ªçc - Th√°ng {{ month }}/{{ year }}</h3>
        <canvas id="revenueByClassChart"></canvas>
    </div>
    
    <!-- Revenue Trend (Line Chart) -->
    <div class="chart-container">
        <h3>üìà Xu h∆∞·ªõng doanh thu 12 th√°ng g·∫ßn nh·∫•t</h3>
        <canvas id="revenueTrendChart"></canvas>
    </div>
</div>

<!-- Summary Table -->
<div class="table-container" style="margin-top: 30px;">
    <h3>Doanh thu chi ti·∫øt - Th√°ng {{ month }}/{{ year }}</h3>
    {% if revenue_by_class %}
    <table>
        <thead>
            <tr>
                <th>L·ªõp h·ªçc</th>
                <th>Doanh thu</th>
            </tr>
        </thead>
        <tbody>
            {% for classroom, revenue in revenue_by_class.items() %}
            <tr>
                <td>{{ classroom }}</td>
                <td>{{ "{:,.0f}".format(revenue) }}ƒë</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="font-weight: bold; background: #ecf0f1;">
                <td>T·ªïng c·ªông</td>
                <td>{{ "{:,.0f}".format(revenue_by_class.values() | sum) }}ƒë</td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üí∞</div>
        <div class="empty-state-message">Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu</div>
    </div>
    {% endif %}
</div>

<script>
// Revenue by Classroom (Bar Chart)
const revenueByClassData = {{ revenue_by_class | tojson }};
const classLabels = Object.keys(revenueByClassData);
const classValues = Object.values(revenueByClassData);

new Chart(document.getElementById('revenueByClassChart'), {
    type: 'bar',
    data: {
        labels: classLabels,
        datasets: [{
            label: 'Doanh thu (VND)',
            data: classValues,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Revenue Trend (Line Chart)
const revenueTrendData = {{ revenue_trend | tojson }};
const trendLabels = revenueTrendData.map(d => d.label);
const trendValues = revenueTrendData.map(d => d.value);

new Chart(document.getElementById('revenueTrendChart'), {
    type: 'line',
    data: {
        labels: trendLabels,
        datasets: [{
            label: 'Doanh thu (VND)',
            data: trendValues,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}
